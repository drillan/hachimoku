# Feature Specification: hachimoku (8moku) マルチエージェントコードレビューツール

**Feature Branch**: `001-architecture-spec`
**Created**: 2026-02-06
**Status**: Draft
**Input**: User description: "drafts をもとにアーキテクチャの仕様を策定してください"

## Clarifications

### Session 2026-02-06

- Q: CLI コマンドの短縮名は何にするか？ → A: ドキュメント上は `8moku` を推奨コマンド名とし、`hachimoku` も互換コマンドとして動作する。Python パッケージ名・import 名は `hachimoku` を維持（Python 識別子の数字始まり制約のため）
- Q: 非verbose モードでの進捗表示と出力ストリーム分離はどうするか？ → A: レビューレポートは stdout に出力し、進捗表示（スピナー・エージェント名等）は stderr に出力する。これによりパイプ利用（`8moku > result.md`）でレポートが汚染されない
- Q: PR の入力方法はどうするか？ → A: `8moku <PR番号>` での明示指定のみ。PR 自動検出は行わない（Q12 で廃止に決定。引数なしは常に git diff レビュー）
- Q: 対象プラットフォームの範囲は？ → A: v0.1 は GitHub のみ。設計上は将来の GitLab/Bitbucket 拡張を考慮する
- Q: レビュー結果の PR コメント投稿は v0.1 スコープか？ → A: v0.1 はターミナル出力のみ。PR コメント投稿は将来対応
- Q: PR メタデータのエージェントコンテキスト注入範囲は？ → A: PR のタイトル・ラベル・リンク Issue を注入する。説明文（body）は除外
- Q: CLI のコマンド体系はどうするか？ → A: レビューがデフォルト動作。`8moku` で現在ブランチをレビュー、`8moku 123` で PR #123 をレビュー。`review` サブコマンドは不要。`agents` 等のサブコマンドは文字列で区別
- Q: `--issue` オプションの動作は？ → A: Issue 番号をプロンプトコンテキストに含めるのみ。エージェント側が `gh` コマンド等のツールで必要な情報を自律的に取得する（システム側での事前取得は行わない）
- Q: エージェント TOML ファイルの呼称は？ → A:「定義ファイル」に統一。「データファイル」は曖昧、「設定ファイル」は `.hachimoku/config.toml`（プロジェクト設定）と混同するため
- Q: 設定ファイルの配置とフォーマットは？ → A: `.hachimoku/config.toml` に統一。ディレクトリ構造は `.hachimoku/config.toml`（設定）+ `.hachimoku/agents/*.toml`（定義）。YAML ではなく TOML で統一し、依存を削減しフォーマットの一貫性を確保する
- Q: PR 自動検出の動作は？ → A: PR 自動検出は行わない。`8moku`（引数なし）は常に git diff レビュー、`8moku <PR番号>` は PR レビュー。PR 番号が存在しなければエラー終了（フォールバックなし）
- Q: レビュー結果の蓄積と出力形式は？ → A: JSONL 形式で `.hachimoku/reviews/` に自動蓄積する。PR レビューは `pr-{番号}.jsonl`、diff レビューは `diff.jsonl` にそれぞれ追記。各行は独立した JSON オブジェクト（コミットハッシュ等メタデータ含む）。タイムスタンプはコミットハッシュから逆算可能なため、ファイル名には含めない
- Q: JSONL 自動蓄積のデフォルト動作と設定可能性は？ → A: デフォルト ON（`save_reviews = true`）。`.hachimoku/config.toml` で `save_reviews = false` に変更可能。`.hachimoku/reviews/` はデフォルトで git 追跡対象とし、除外はユーザー判断に委ねる
- Q: `8moku init` 実行時に `.hachimoku/` が既に存在する場合の動作は？ → A: 既存ファイルはスキップし、不足ファイルのみ生成する。`--force` オプションで全ファイルを上書き可能
- Q: `8moku init` で生成される定義ファイルの範囲は？ → A: `config.toml`（コメント付きデフォルト）+ ビルトイン6エージェント定義を `.hachimoku/agents/` にコピー + `reviews/` ディレクトリ。ビルトイン定義はカスタマイズの起点として配置する
- Q: ファイルパス指定によるレビューの対象範囲は？ → A: 単一ファイル、複数ファイル、ディレクトリ（再帰探索、深さ制限なし）、glob パターンをサポートする。位置引数として指定し、PR 番号との区別は整数判定で行う
- Q: file モードで glob パターンをサポートするか？ → A: サポートする。`8moku "src/**/*.py"` のように指定可能。シェル展開を避けるためクォート推奨
- Q: file モードは Git リポジトリ外でも動作するか？ → A: 動作する。git 管理外の執筆タスク（ドキュメント、文章等）のレビューに対応するため。プロジェクト設定（`.hachimoku/`）の検出は現在のディレクトリから親ディレクトリへ遡って探索する
- Q: file モードのレビュー結果はどこに蓄積されるか？ → A: `.hachimoku/reviews/files.jsonl` に蓄積する。diff/PR とは区別する形式で、ファイルパスリスト・実行日時・作業ディレクトリをメタデータとして含む
- Q: `8moku init` は Git リポジトリ外でも動作するか？ → A: `8moku init` は Git リポジトリ内でのみ動作する。Git リポジトリ外では file モードがデフォルト設定（ビルトインエージェント）のみで動作し、カスタマイズが必要な場合はユーザーが `.hachimoku/` を手動作成する

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 基本的なコードレビュー実行 (Priority: P1)

開発者が自分の変更に対してマルチエージェントレビューを実行し、コード品質・バグ・セキュリティの問題を検出する。

開発者はターミナルからレビューコマンドを実行する。システムは変更されたファイルを自動検出し、適用可能なエージェントを選択して逐次実行する。各エージェントの結果は統一されたレポートとして出力される。

**Why this priority**: これがツールの根幹機能であり、この機能なしにはプロダクトとしての価値がない。最小限のMVPとしてこの機能単独で開発者にレビュー結果を提供できる。

**Independent Test**: ターミナルから `8moku` を実行し、変更差分に対するレビュー結果が Markdown 形式で stdout に表示されることで検証可能。

**Acceptance Scenarios**:

1. **Given** Git リポジトリ内にコミット済みの変更がある状態, **When** ユーザーがレビューコマンドを実行, **Then** 適用可能な全エージェントが逐次実行され、重大度別に分類されたレビューレポートが Markdown で出力される
2. **Given** 変更差分にエラーハンドリングコードが含まれる状態, **When** レビューを実行, **Then** silent-failure-hunter エージェントが自動的に適用対象として選択される
3. **Given** 変更差分にクラス定義が含まれる状態, **When** レビューを実行, **Then** type-design-analyzer エージェントが自動的に適用対象として選択される
4. **Given** レビュー実行中にエージェントがタイムアウトした場合, **When** タイムアウト時間を超過, **Then** FR-006 に従い当該エージェントのみスキップされ、エラー情報がレポートに含まれ、他のエージェントの結果は正常に出力される

---

### User Story 2 - 並列実行によるレビュー高速化 (Priority: P2)

開発者が複数エージェントを並列に実行し、レビュー全体の所要時間を短縮する。

**Why this priority**: 逐次実行（P1）が動作した後の自然な改善。CI/CD パイプラインでの実用性に直結する。

**Independent Test**: 並列オプション付きでレビューを実行し、全エージェントの実行時間合計が逐次実行時より短いことで検証可能。

**Acceptance Scenarios**:

1. **Given** 複数エージェントが適用可能な状態, **When** 並列実行オプション付きでレビューを実行, **Then** 全エージェントが同時に実行され、逐次実行より短い時間で完了する
2. **Given** 並列実行中に1つのエージェントがエラーで失敗, **When** エラーが発生, **Then** 他のエージェントは影響を受けず完了し、失敗したエージェントの情報がレポートに含まれる
3. **Given** 並列実行中にユーザーが Ctrl+C で中断, **When** 中断シグナルを受信, **Then** 全エージェントが安全に停止し、完了済みの結果が部分レポートとして出力される

---

### User Story 3 - データ駆動型エージェント定義によるカスタマイズ (Priority: P2)

開発者がプロジェクト固有のレビューエージェントを定義ファイルとして追加し、追加のコーディングなしにレビュー観点を拡張する。

**Why this priority**: 拡張性はツールの長期的な価値に直結する。ビルトインエージェントだけでは各プロジェクトの固有要件をカバーできない。

**Independent Test**: プロジェクト内にエージェント定義ファイルを配置し、レビュー実行時にカスタムエージェントが動作することで検証可能。

**Acceptance Scenarios**:

1. **Given** プロジェクトの `.hachimoku/agents/` ディレクトリにカスタムエージェント定義ファイルが配置されている, **When** レビューを実行, **Then** カスタムエージェントがビルトインエージェントと共に読み込まれ実行される
2. **Given** カスタムエージェントがビルトインエージェントと同名で定義されている, **When** レビューを実行, **Then** カスタム定義がビルトイン定義を上書きする
3. **Given** エージェント定義ファイルに不正な形式のデータがある, **When** エージェントの読み込み時, **Then** FR-006 に従い不正なエージェントのみスキップされ、エラーメッセージが stderr に表示され、他のエージェントは正常に動作する

---

### User Story 4 - 構造化出力・結果蓄積・CI/CD 統合 (Priority: P3)

開発者またはCI/CDシステムが、レビュー結果を機械可読な形式で取得し、パイプラインの判定基準として利用する。レビュー結果は JSONL 形式で自動蓄積され、過去のレビュー履歴を参照できる。

**Why this priority**: CI/CD 統合はツールの自動化活用に不可欠だが、まず人間向けの基本機能（P1, P2）が安定してから取り組むべき。

**Independent Test**: JSON 出力オプションでレビューを実行し、出力がスキーマに準拠した有効な JSON であること、および `.hachimoku/reviews/` に結果が蓄積されることで検証可能。

**Acceptance Scenarios**:

1. **Given** レビュー実行時に JSON 出力形式を指定, **When** レビューが完了, **Then** 定義済みスキーマに準拠した JSON が stdout に出力される
2. **Given** レビュー結果に重大な問題が含まれる, **When** レビューが完了, **Then** 終了コード 1（Critical あり）が返される
3. **Given** レビュー結果に重要だが重大でない問題のみ含まれる, **When** レビューが完了, **Then** 終了コード 2（Important あり、Critical なし）が返される
4. **Given** 全エージェントが実行失敗, **When** レビューが完了, **Then** 終了コード 3（実行エラー）が返される
5. **Given** PR #123 のレビューを実行, **When** レビューが完了, **Then** `.hachimoku/reviews/pr-123.jsonl` に結果が1行追記される（コミットハッシュ・レビュー結果を含む）
6. **Given** 同じ PR に対して新コミット後に再レビュー, **When** レビューが完了, **Then** 同じ JSONL ファイルに新しいコミットハッシュで1行追記され、過去の結果も保持される
7. **Given** 引数なしでレビューを実行, **When** レビューが完了, **Then** `.hachimoku/reviews/diff.jsonl` に結果が1行追記される（コミットハッシュ・ブランチ名を含む）
8. **Given** 設定で `save_reviews = false` が指定されている, **When** レビューが完了, **Then** JSONL ファイルへの蓄積は行われず、stdout/ファイル出力のみが生成される

---

### User Story 5 - プロジェクト設定によるレビュー動作のカスタマイズ (Priority: P3)

開発者がプロジェクトごとにデフォルトの実行設定（使用モデル・タイムアウト・エージェント有効/無効など）を設定ファイルで管理する。

**Why this priority**: 設定の柔軟性は実運用で必要だが、デフォルト値で動作する基本機能が先に必要。

**Independent Test**: 設定ファイルを配置してレビューを実行し、設定が反映されていることで検証可能。

**Acceptance Scenarios**:

1. **Given** プロジェクトに設定ファイルが存在する, **When** レビューを実行, **Then** 設定ファイルの値がデフォルト値を上書きして適用される
2. **Given** 設定ファイルとコマンドラインオプションの両方で同じ設定項目が指定されている, **When** レビューを実行, **Then** コマンドラインオプションが優先される
3. **Given** 設定ファイルで特定のエージェントが無効化されている, **When** レビューを実行, **Then** 無効化されたエージェントはスキップされる

---

### User Story 6 - PR 指定・Issue 連携によるレビュー (Priority: P2)

開発者が PR 番号を直接指定してレビューを実行する。また、`--issue` オプションで関連 Issue 番号を指定すると、エージェントが自律的に Issue 情報を取得してレビューに活用する。

**Why this priority**: PR ワークフローは多くの開発チームの標準であり、ブランチ差分レビュー（P1）の自然な拡張。Issue 連携により「この変更が仕様を満たしているか」という観点のレビューが可能になる。

**Independent Test**: `8moku 123` で PR #123 のレビューが実行され、`8moku --issue 122` で Issue コンテキスト付きのレビューが実行されることで検証可能。

**Acceptance Scenarios**:

1. **Given** PR 番号を直接指定する, **When** `8moku 123` を実行, **Then** PR #123 の差分とメタデータ（タイトル・ラベル・リンク Issue）がレビュー対象となる
2. **Given** 存在しない PR 番号を指定する, **When** `8moku 999` を実行, **Then** PR が見つからない旨のエラーメッセージが表示され、終了コード 4（入力エラー）で終了する
3. **Given** PR 番号なしで Issue 番号のみを指定する（git diff レビュー + Issue コンテキスト）, **When** `8moku --issue 122` を実行, **Then** git diff に対するレビューが実行され、Issue 番号がプロンプトコンテキストに含まれ、エージェントが `gh` コマンド等で Issue 情報を自律的に取得してレビューに活用する
4. **Given** PR 番号と Issue 番号を同時に指定する, **When** `8moku 123 --issue 122` を実行, **Then** PR #123 の差分・メタデータに加えて Issue 番号もコンテキストに含まれる
5. **Given** GitHub API が利用不可（認証なし・ネットワークエラー）, **When** `8moku 123` を実行, **Then** エラーメッセージが表示され終了する（git diff へのフォールバックは行わない）

---

### User Story 7 - エージェント管理コマンド (Priority: P3)

開発者が利用可能なエージェントの一覧表示や詳細確認を行い、レビュー動作を理解する。

**Why this priority**: 利便性機能であり、レビュー機能自体が動作した後に付加価値として提供する。

**Independent Test**: エージェント一覧コマンドを実行し、ビルトインおよびカスタムエージェントの情報が表示されることで検証可能。

**Acceptance Scenarios**:

1. **Given** ビルトインエージェントとカスタムエージェントの両方が存在する, **When** エージェント一覧コマンドを実行, **Then** 全エージェントの名前・モデル・フェーズ・スキーマが一覧表示され、カスタムエージェントには目印が付く
2. **Given** 特定のエージェント名を指定, **When** エージェント詳細コマンドを実行, **Then** そのエージェントの全設定情報（説明、適用条件、プロンプト概要など）が表示される

---

### User Story 8 - プロジェクト初期化 (Priority: P2)

開発者が `8moku init` を実行して `.hachimoku` ディレクトリを作成し、デフォルトの設定ファイル・エージェント定義ファイル・レビュー蓄積ディレクトリを生成する。

**Why this priority**: 初期セットアップはユーザーの最初の体験であり、設定やカスタマイズの起点となる。ビルトインエージェント定義のコピーにより、カスタマイズの学習コストを下げる。

**Independent Test**: `8moku init` を実行し、`.hachimoku/` 配下に設定ファイル・エージェント定義・レビューディレクトリが生成されることで検証可能。

**Acceptance Scenarios**:

1. **Given** `.hachimoku/` ディレクトリが存在しないプロジェクト, **When** `8moku init` を実行, **Then** `.hachimoku/config.toml`（コメント付きデフォルト設定）、`.hachimoku/agents/` にビルトイン6エージェントの定義ファイル、`.hachimoku/reviews/` ディレクトリが生成される
2. **Given** `.hachimoku/` ディレクトリが既に存在し一部ファイルがカスタマイズ済み, **When** `8moku init` を実行, **Then** 既存ファイルはスキップされ、不足ファイルのみが追加生成される
3. **Given** `.hachimoku/` ディレクトリが既に存在する, **When** `8moku init --force` を実行, **Then** 全ファイルがデフォルト内容で上書きされる
4. **Given** Git リポジトリ外で実行, **When** `8moku init` を実行, **Then** エラーメッセージとともに終了する

---

### User Story 9 - ファイルパス指定によるレビュー (Priority: P2)

開発者がファイルパスを直接指定してレビューを実行する。Git diff に限定されず、既存コードの全体レビューや Git 管理外のドキュメントレビューが可能になる。

**Why this priority**: Git diff/PR レビュー（P1/P2）の自然な拡張であり、レビュー対象の柔軟性を高める。ドキュメントレビューや既存コードの全体レビューという新しいユースケースを開拓する。

**Independent Test**: `8moku src/auth.py` でファイル全体のレビューが実行され、`.hachimoku/reviews/files.jsonl` に結果が蓄積されることで検証可能。

**Acceptance Scenarios**:

1. **Given** 単一ファイルパスを指定する, **When** `8moku src/auth.py` を実行, **Then** 指定ファイルの全体がレビュー対象となり、適用可能なエージェントが実行される
2. **Given** 複数ファイルパスを指定する, **When** `8moku src/auth.py src/api/client.py` を実行, **Then** 両方のファイルがレビュー対象となり、結果が統合される
3. **Given** ディレクトリを指定する, **When** `8moku src/` を実行, **Then** `src/` 配下の全ファイルが再帰的に探索され、レビュー対象となる
4. **Given** glob パターンを指定する, **When** `8moku "src/**/*.py"` を実行, **Then** パターンにマッチする全ファイルがレビュー対象となる
5. **Given** 存在しないファイルパスを指定する, **When** `8moku nonexistent.py` を実行, **Then** ファイルが見つからない旨のエラーメッセージが表示され、終了コード 4（入力エラー）で終了する
6. **Given** Git リポジトリ外でファイルパスを指定する, **When** `8moku document.md` を実行, **Then** Git に依存せずレビューが実行される（設定ファイルは親ディレクトリから探索）
7. **Given** ファイルパスと `--issue` オプションを併用する, **When** `8moku src/auth.py --issue 122` を実行, **Then** Issue 番号がプロンプトコンテキストに含まれる
8. **Given** 設定項目 `max_files_per_review` を超えるファイル数を指定する, **When** `8moku "src/**/*.py"` を実行（対象が `max_files_per_review` 超）, **Then** 警告メッセージが表示され確認を求められる（`--no-confirm` で回避可能）
9. **Given** file モードでレビューを実行, **When** レビューが完了, **Then** `.hachimoku/reviews/files.jsonl` に結果が追記される（ファイルパスリスト・実行日時・作業ディレクトリを含む）

---

### Edge Cases

- エージェント定義ファイルで参照されたスキーマが存在しない場合、バリデーションエラーとしてスキップし明確なエラーメッセージを表示する
- diff モード・PR モードにおいて Git リポジトリ外で実行した場合、わかりやすいエラーメッセージとともに終了する（file モードは Git リポジトリ外でも動作可能）
- diff が空（変更なし）の場合、レビュー対象がない旨を通知して正常終了する
- 非常に大きな diff（数千行以上）の場合でも、タイムアウト制御により確実にプロセスが終了する
- プロジェクトに CLAUDE.md が存在しない場合、ガイドラインセクションなしでレビューが正常に動作する
- エージェント定義の `file_patterns` や `content_patterns` が空の場合、そのルールは常に不一致として扱われる（`always = true` でない限りスキップ）
- 同一フェーズ内で複数エージェントの結果が矛盾する場合、両方の見解をそのまま出力する（システムは判定しない）
- 指定された PR 番号が存在しない場合、明確なエラーメッセージとともに終了する
- GitHub CLI (`gh`) が未インストールまたは未認証の状態で PR 番号を指定した場合、明確なエラーメッセージとともに終了する（引数なしの git diff レビューは影響を受けない）
- `8moku init --force` 実行時、既存のカスタマイズ済みファイルはデフォルト内容で上書きされる（ユーザーの責任。バックアップは行わない）
- file モードで指定されたディレクトリが空の場合、レビュー対象がない旨を通知して正常終了する
- file モードで指定された glob パターンにマッチするファイルがない場合、レビュー対象がない旨を通知して正常終了する
- file モードでは相対パスと絶対パスの両方をサポートする。相対パスは現在の作業ディレクトリから解決される
- file モードでシンボリックリンクを指定した場合、リンク先の実体ファイルをレビュー対象とする。ディレクトリ再帰探索時にシンボリックリンクによる循環参照が検出された場合、当該リンクをスキップし警告メッセージを stderr に表示する
- file モードで `.hachimoku/` ディレクトリが見つからない場合（Git リポジトリ外での実行を含む）、デフォルト設定（ビルトインエージェント）でレビューを実行する（警告メッセージを表示）。`8moku init` は Git リポジトリ内でのみ動作するため、Git リポジトリ外でのカスタマイズは `.hachimoku/` の手動作成が必要
- diff モード・PR モードと file モードは同時に指定できない。PR 番号とファイルパスが混在する場合はエラーとなる（例: `8moku 123 src/auth.py` は不可）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはレビュー対象を以下の3種類のモードで取得できなければならない:
  - **diff モード**（引数なし）: Git リポジトリのブランチ間差分を自動取得し、変更内容をレビュー対象とする。比較対象ブランチは設定項目 `base_branch`（デフォルト: `main`）で指定する
  - **PR モード**（`8moku <PR番号>`）: 指定された PR の差分とメタデータ（タイトル・ラベル・リンク Issue）を取得する
  - **file モード**（`8moku <ファイルパス...>`）: 指定されたファイルの全体をレビュー対象とする。複数ファイル、ディレクトリ（再帰探索、深さ制限なし）、glob パターンをサポートする。Git リポジトリ外でも動作可能とする
- **FR-002**: システムは複数の専門エージェントを逐次または並列に実行し、各エージェントの結果を統一されたレポートに集約できなければならない
- **FR-003**: システムはエージェント定義ファイルからエージェントを読み込み、動的にレビューエージェントを構築・実行できなければならない
- **FR-004**: システムは各エージェントの出力を事前定義されたスキーマで型検証し、不正な出力をエラーとして検出できなければならない
- **FR-005**: システムは変更ファイルのパターンや差分内容に基づいて、適用すべきエージェントを自動選択できなければならない
- **FR-006**: システムは個別エージェントの失敗（タイムアウト・実行エラー）を許容し、成功したエージェントの結果のみで部分レポートを生成できなければならない
- **FR-007**: システムはエージェントごとのタイムアウトと最大ターン数による二段階のプロセス制御を提供し、確実にプロセスを終了できなければならない
- **FR-008**: システムはレビュー結果を Markdown および JSON の2形式で出力できなければならない
- **FR-009**: システムはレビュー結果の重大度に応じた終了コード（0: 問題なし, 1: Critical, 2: Important, 3: 実行エラー, 4: 入力エラー）を返さなければならない。入力エラーには PR 未発見・diff/PR モードでの Git リポジトリ外実行・`gh` 未認証・file モードでのファイル未発見等を含む
- **FR-010**: システムは設定ファイル階層（CLI > `.hachimoku/config.toml` > `pyproject.toml [tool.hachimoku]` > `~/.config/hachimoku/config.toml` > デフォルト）に従って設定を解決できなければならない。設定フォーマットは TOML に統一する
- **FR-011**: システムはプロジェクト固有のカスタムエージェント定義を読み込み、ビルトインエージェントと同等に実行できなければならない
- **FR-012**: システムは対象プロジェクトの CLAUDE.md を検出した場合、その内容をエージェントのコンテキストとして自動注入しなければならない
- **FR-013**: システムは SIGINT/SIGTERM シグナルを受信した場合、実行中のエージェントを安全に停止し、それまでの結果を部分レポートとして出力しなければならない
- **FR-014**: システムは6つのビルトインエージェント（コードレビュー、サイレント障害検出、テスト分析、型設計分析、コメント分析、コード簡潔化）を標準提供しなければならない
- **FR-015**: システムは各エージェントの実行コスト情報を集計し、オプションで表示できなければならない
- **FR-016**: ユーザーは利用可能なエージェントの一覧および各エージェントの詳細情報をコマンドラインから確認できなければならない
- **FR-017**: システムは `8moku`（推奨短縮名）および `hachimoku`（互換フルネーム）の両方のコマンド名で同一の機能を提供しなければならない
- **FR-018**: システムはレビューレポートを stdout に出力し、進捗表示・エラー情報・詳細ログを stderr に出力することで、パイプやリダイレクトでレポートのみを取得可能にしなければならない
- **FR-019**: v0.1 では GitHub の PR を対象プラットフォームとする。将来の GitLab/Bitbucket 拡張に備え、プラットフォーム固有のロジックは分離可能な設計としなければならない
- **FR-020**: `8moku <PR番号>` で指定された PR が存在しない場合、システムは明確なエラーメッセージとともに終了しなければならない（git diff へのフォールバックは行わない）
- **FR-021**: レビューがデフォルト動作となり、位置引数によってレビューモードが自動判定されなければならない。判定ルールは以下の優先順:
  1. サブコマンド文字列（`init`, `agents`, `config`）→ サブコマンド実行
  2. 整数のみ（`8moku 123`）→ PR モード（指定 PR のレビュー）
  3. パスライク文字列（`/`, `\`, `*`, `?`, `.` のいずれかを含む）→ file モード（指定ファイルのレビュー）
  4. ファイルシステム上に存在するパス（`Makefile`, `Dockerfile`, `LICENSE` 等の拡張子なしファイル名）→ file モード
  5. 引数なし（`8moku`）→ diff モード（現在ブランチの変更差分レビュー）
  6. 上記のいずれにも該当しない → エラー（終了コード 4）

  `review` サブコマンドは不要とする。PR 番号とファイルパスの同時指定は不可とする
- **FR-022**: PR を対象とするレビューでは、PR のタイトル・ラベル・リンク Issue をエージェントの追加コンテキストとして注入しなければならない。PR の説明文（body）は注入しない
- **FR-023**: `8moku <PR番号>` 実行時に GitHub API が利用不可の場合（未認証・ネットワークエラー）、システムはエラーメッセージとともに終了しなければならない
- **FR-024**: ユーザーは `--issue <番号>` オプションで関連 Issue を指定できなければならない。Issue 番号はエージェントのプロンプトコンテキストに含まれ、エージェントが `gh` コマンド等のツールで自律的に詳細情報を取得する
- **FR-025**: システムはレビュー結果を `.hachimoku/reviews/` ディレクトリに JSONL 形式で自動蓄積しなければならない（デフォルト ON）。レビューモードごとに蓄積先ファイルが分かれる: diff レビューは `diff.jsonl`、PR レビューは `pr-{番号}.jsonl`、file レビューは `files.jsonl` に追記する。この動作は設定項目 `save_reviews`（デフォルト: `true`）で無効化可能とする
- **FR-026**: JSONL の各行は独立した JSON オブジェクトとし、レビューモード判別キー（`review_mode`）・レビュー実行日時・AgentResult リスト・全体サマリーを共通メタデータとして含まなければならない。モード固有のメタデータは ReviewHistoryRecord の各バリアント定義（FR-DM-011）に従う
- **FR-027**: `8moku init` コマンドは `.hachimoku/` ディレクトリを作成し、コメント付きデフォルト設定ファイル（`config.toml`）、ビルトイン6エージェントの定義ファイル（`agents/*.toml`）、レビュー蓄積ディレクトリ（`reviews/`）を生成しなければならない
- **FR-028**: `8moku init` は既存ファイルをスキップし不足ファイルのみ生成する。`--force` オプション指定時は全ファイルをデフォルト内容で上書きする
- **FR-029**: file モードでは以下の入力形式をサポートしなければならない:
  - **単一ファイル**: `8moku src/auth.py`
  - **複数ファイル**: `8moku src/auth.py src/api/client.py`（位置引数として複数指定）
  - **ディレクトリ**: `8moku src/`（再帰的に全ファイルを探索、深さ制限なし）
  - **glob パターン**: `8moku "src/**/*.py"`（シェル展開を避けるためクォート推奨）

  Git リポジトリ外でも動作可能とする。指定されたファイルパスが存在しない場合は終了コード 4（入力エラー）で終了する。`ApplicabilityRule` の `file_patterns` は CLI で指定されたファイルパスに対して適用され、`content_patterns` はファイル全体の内容に対して適用される
- **FR-030**: file モードのレビュー結果は `.hachimoku/reviews/files.jsonl` に蓄積しなければならない。各行のメタデータには以下を含む: レビュー対象となったファイルパスのリスト、レビュー実行日時（ISO 8601 形式）、レビュー実行時の作業ディレクトリ（絶対パス）、AgentResult リスト、全体サマリー
- **FR-031**: file モードは `--issue` オプションと併用可能としなければならない。`8moku src/auth.py --issue 122` のように指定した場合、Issue 番号がエージェントのプロンプトコンテキストに含まれる（diff モード・PR モードと同様の動作）
- **FR-032**: file モードで指定されたファイル数（glob 展開・ディレクトリ再帰探索後の最終ファイル数）が設定項目 `max_files_per_review`（デフォルト: 100）を超える場合、警告メッセージを表示し確認を求めなければならない。`--no-confirm` オプション指定時は確認をスキップする
- **FR-033**: システムは LLM プロバイダーをモデル名のプレフィックスで決定しなければならない（Issue #125 で `provider` フィールドを廃止しプレフィックスベースに統一）。`claudecode:` プレフィックスは Claude Code 内蔵モデル（API キー不要、`claudecode-model` パッケージの `ClaudeCodeModel` を使用）、`anthropic:` プレフィックスは Anthropic API 直接呼び出し（`ANTHROPIC_API_KEY` 必須）を示す。プレフィックスなしまたは未知のプレフィックスはエラーとする。デフォルトモデルは `claudecode:claude-sonnet-4-5`。プロバイダー解決は Agent 構築直前に `resolve_model()` で行う

### Key Entities

- **エージェント定義 (Agent Definition)**: レビューエージェントの名前・説明・使用モデル・許可ツール・出力スキーマ・システムプロンプト・適用条件を包含する定義データ。定義ファイルとして外部化される
- **適用ルール (Applicability Rule)**: エージェントをいつ適用するかを決定する条件セット。常時適用フラグ、ファイル名パターン、差分内容パターン、実行フェーズ（early/main/final）から構成される。レビューモードによって適用対象が異なる: diff/PR モードでは `file_patterns` は diff で変更されたファイルに対してマッチングし `content_patterns` は差分内容に対してマッチングする。file モードでは `file_patterns` は CLI で指定されたファイルパスに対してマッチングし `content_patterns` はファイル全体の内容に対してマッチングする
- **出力スキーマ (Result Schema)**: 各エージェントの出力形式を規定する型定義。スコア付き問題、重大度分類問題、テストギャップ評価、多次元分析、カテゴリ分類、改善提案の6種類が存在する
- **レビュー問題 (Review Issue)**: 各エージェントが検出した問題を統一的に表現するエンティティ。エージェント名・重大度・ファイル位置・説明・推奨アクション・カテゴリを持つ
- **レビューレポート (Review Report)**: 全エージェントの結果を集約した最終出力。問題を重大度別にグループ化し、エージェントごとのステータス・所要時間・コストも含む
- **エージェント結果 (Agent Result)**: 単一エージェントの実行結果。正常完了時のレビュー問題リストに加え、エラー時のエラー情報・タイムアウト情報も格納する
- **プロジェクト設定 (Configuration)**: 実行設定（デフォルトモデル・タイムアウト・並列モード等）、出力設定（`save_reviews` によるレビュー蓄積の有効/無効を含む）、Git 設定、エージェント個別設定を統合した設定データ。`.hachimoku/config.toml` に TOML 形式で記述し、複数の設定ソースから階層的に解決される
- **PR メタデータ (PR Metadata)**: GitHub PR から取得されるコンテキスト情報。タイトル・ラベル・リンク Issue で構成される。`8moku <PR番号>` で明示指定時に取得不可の場合はエラー終了する（FR-023）。引数なし実行時は PR メタデータを使用しない（SC-011）
- **レビュー履歴 (Review History)**: `.hachimoku/reviews/` に JSONL 形式で蓄積されるレビュー結果の時系列データ。レビューモードごとに蓄積ファイルが分かれる: diff レビューは `diff.jsonl`（コミットハッシュ・ブランチ名を含む）、PR レビューは `pr-{番号}.jsonl`（コミットハッシュ・PR 番号を含む）、file レビューは `files.jsonl`（ファイルパスリスト・実行日時・作業ディレクトリを含む）。各行は独立した JSON オブジェクトであり、レビュー結果・エージェント情報・モード固有のメタデータを含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: レビューコマンドの実行開始から結果出力完了まで、設定されたタイムアウト時間＋10秒以内に確実にプロセスが終了する
- **SC-002**: 6つのビルトインエージェントのうち少なくとも1つが正常完了すれば、ユーザーに有意味なレビューレポートが出力される
- **SC-003**: エージェント定義ファイルを配置するだけで、コード変更なしにカスタムエージェントの追加が完了する（追加作業5分以内）
- **SC-004**: 並列実行モードでの全体所要時間が、最も遅いエージェントの実行時間＋オーバーヘッド10%以内に収まる
- **SC-005**: JSON 出力がスキーマに100%準拠し、外部ツールやスクリプトから解析可能である
- **SC-006**: 個別エージェントの失敗率が50%を超えても、成功したエージェントの結果のみで部分レポートが正常に生成される
- **SC-007**: Ctrl+C による中断後3秒以内に全プロセスが終了し、それまでの結果が出力される
- **SC-008**: 設定ファイルの階層解決が正しく動作し、上位の設定が下位を確実に上書きする
- **SC-009**: `8moku > result.md` のようなリダイレクト時に、出力ファイルにはレビューレポートのみが含まれ、進捗情報が混入しない
- **SC-010**: PR が存在するブランチでのレビュー実行時、PR メタデータ（タイトル・ラベル・リンク Issue）がエージェントのコンテキストに含まれる
- **SC-011**: 引数なしの `8moku` 実行は GitHub API に依存せず、git diff のみで正常にレビューが完了する
